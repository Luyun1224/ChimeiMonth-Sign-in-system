<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 工作坊簽到系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts - Noto Sans TC 來優化中文字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 ionicons 圖示庫 -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #e8f1f5;
        }
        .main-container {
            max-width: 1600px;
            margin: auto;
        }
        .table-header {
            @apply px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider;
            background-color: #5B9FB6;
            color: white;
        }
        .table-cell {
            @apply px-4 py-4 border-b border-gray-200 bg-white text-sm;
        }
        /* Modal 彈出視窗樣式 */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* 數字跳動動畫 */
        @keyframes number-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .number-pop-animation {
            animation: number-pop 0.3s ease-out;
        }
        /* Toast 通知樣式 */
        .toast-show {
            opacity: 1;
            transform: translateY(0);
        }
        /* Loading 遮罩 */
        #loading-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader {
            border-top-color: #5B9FB6;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 頁面容器 -->
    <div id="page-container" class="main-container p-4 md:p-8">
        <!-- 頂部標題 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6" style="background: linear-gradient(135deg, #2B4856 0%, #5B9FB6 100%);">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <div class="flex items-baseline gap-4 justify-center md:justify-start">
                        <h1 class="text-4xl md:text-5xl font-bold text-white">AI 數位賦能工作坊</h1>
                        <h2 class="text-4xl md:text-5xl font-bold text-yellow-300" style="color: #F5C17A;">簽到系統</h2>
                    </div>
                    <p class="text-white opacity-90 mt-3 text-sm md:text-base flex items-center gap-2 justify-center md:justify-start">
                        <ion-icon name="calendar-outline" class="text-lg"></ion-icon>
                        <span>2025/11/23(日) 9:45─12:15</span>
                        <ion-icon name="location-outline" class="text-lg ml-2"></ion-icon>
                        <span>奇美博物館豐收廳/貓頭鷹手作坊</span>
                    </p>
                </div>
                <div class="text-right">
                    <span id="realtime-clock" class="text-xl font-mono text-white opacity-90 hidden md:inline-block"></span>
                </div>
            </div>
        </div>

        <!-- 內容 -->
        <div class="space-y-6">
            <!-- 儀表板 -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <p class="text-gray-500 mb-6 flex items-center gap-2">
                    <ion-icon name="stats-chart-outline" class="text-xl"></ion-icon>
                    <span>即時監控工作坊報到狀況</span>
                </p>
                
                <!-- 主要儀表板 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 rounded-xl text-center" style="background-color: #A8C5D1;">
                        <h3 class="text-md font-semibold" style="color: #2B4856;">總報名人數</h3>
                        <p class="text-4xl font-bold mt-1" style="color: #1A2328;" id="totalAttendees">0</p>
                    </div>
                    <div class="p-4 rounded-xl text-center" style="background-color: #5B9FB6;">
                        <h3 class="text-md font-semibold text-white">總報到人數</h3>
                        <p class="text-4xl font-bold text-white mt-1" id="totalCheckedIn">0</p>
                    </div>
                    <div class="p-4 rounded-xl text-center" style="background-color: #E89152;">
                        <h3 class="text-md font-semibold text-white">總出席率</h3>
                        <p class="text-4xl font-bold text-white mt-1" id="totalAttendanceRate">0%</p>
                    </div>
                </div>
                
                <!-- 各組報到狀況 -->
                <div class="mt-8">
                    <p class="text-gray-500 mb-4 flex items-center gap-2">
                        <ion-icon name="people-outline" class="text-xl"></ion-icon>
                        <span>各組報到狀況</span>
                    </p>
                    <div id="group-stats-container" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                        <!-- 這裡將由 JS 動態填入 -->
                    </div>
                </div>
            </div>

            <!-- 功能列 -->
            <div class="bg-white rounded-xl shadow-md p-4">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="relative flex-grow w-full">
                        <input type="search" id="searchInput" placeholder="搜尋姓名、服務單位/部門或組別..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <ion-icon name="search-outline" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></ion-icon>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <button id="addAttendeeBtn" class="w-full md:w-auto text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition" style="background-color: #5B9FB6;" onmouseover="this.style.backgroundColor='#2B4856'" onmouseout="this.style.backgroundColor='#5B9FB6'">
                            <ion-icon name="add-outline"></ion-icon>新增參與者
                        </button>
                        <button id="exportBtn" class="w-full md:w-auto text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition" style="background-color: #E89152;" onmouseover="this.style.backgroundColor='#D37644'" onmouseout="this.style.backgroundColor='#E89152'">
                            <ion-icon name="download-outline"></ion-icon>匯出資料
                        </button>
                    </div>
                </div>
            </div>

            <!-- 資料表格 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="table-header">狀態</th>
                                <th class="table-header">組別</th>
                                <th class="table-header">身份類別</th>
                                <th class="table-header">服務單位/部門</th>
                                <th class="table-header">職稱</th>
                                <th class="table-header">姓名</th>
                                <th class="table-header">操作</th>
                            </tr>
                        </thead>
                        <tbody id="attendeeTableBody">
                            <!-- JS 動態填入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="attendeeModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 pointer-events-none opacity-0">
        <div class="absolute w-full h-full bg-gray-900 opacity-50" id="modal-overlay"></div>
        <div id="modal-content" class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto transform -translate-y-10" style="max-height: 80vh;">
            <div class="py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="modalTitle" class="text-2xl font-bold">新增參與者</p>
                    <div id="modal-close" class="cursor-pointer z-50">
                        <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                    </div>
                </div>
                <div class="my-5 overflow-y-auto" style="max-height: 60vh; padding-right: 1em;">
                    <form id="attendeeForm">
                        <input type="hidden" id="editUuid">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold">姓名</label>
                                <input id="formName" type="text" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="text-sm font-semibold">組別</label>
                                <select id="formGroup" class="w-full p-2 border rounded bg-white">
                                    <option>第一組</option>
                                    <option>第二組</option>
                                    <option>第三組</option>
                                    <option>第四組</option>
                                    <option>第五組</option>
                                    <option>第六組</option>
                                    <option>第七組</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="text-sm font-semibold">服務單位/部門</label>
                            <input id="formOrganization" type="text" class="w-full p-2 border rounded">
                        </div>
                        <div class="mt-4">
                            <label class="text-sm font-semibold">職稱</label>
                            <input id="formTitle" type="text" class="w-full p-2 border rounded">
                        </div>
                        <div class="mt-4">
                            <label class="text-sm font-semibold">身份類別</label>
                            <select id="formCategory" class="w-full p-2 border rounded bg-white">
                                <option>學員</option>
                                <option>講師</option>
                                <option>工作人員</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="flex justify-end pt-2 border-t mt-4">
                    <button id="formCancel" class="px-4 bg-transparent p-3 rounded-lg hover:bg-gray-100 mr-2" style="color: #5B9FB6;">取消</button>
                    <button id="formSave" class="px-4 p-3 rounded-lg text-white" style="background-color: #5B9FB6;" onmouseover="this.style.backgroundColor='#2B4856'" onmouseout="this.style.backgroundColor='#5B9FB6'">儲存</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="alertModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 pointer-events-none opacity-0">
        <div class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-lg z-50 transform -translate-y-10 text-center p-6">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-4" style="background-color: #A8C5D1;">
                <ion-icon name="sparkles-outline" class="text-5xl" style="color: #2B4856;"></ion-icon>
            </div>
            <h3 id="alertTitle" class="text-xl leading-6 font-bold text-gray-900">簽到完成！</h3>
            <div id="alertIdBadge" class="mt-3 text-md text-gray-700 space-y-2"></div>
            <div class="mt-4 border-t pt-4">
                <div id="alertMessage" class="text-md text-gray-700 space-y-2"></div>
            </div>
            <div class="mt-6">
                <button id="alertCloseBtn" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition" style="background-color: #5B9FB6;" onmouseover="this.style.backgroundColor='#2B4856'" onmouseout="this.style.backgroundColor='#5B9FB6'">太棒了！</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 pointer-events-none opacity-0">
        <div class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-lg z-50 transform -translate-y-10 text-center p-6">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-4" style="background-color: #F5C17A;">
                <ion-icon name="warning-outline" class="text-5xl" style="color: #D37644;"></ion-icon>
            </div>
            <h3 id="confirmTitle" class="text-xl leading-6 font-bold text-gray-900">確定要執行此操作嗎？</h3>
            <div class="mt-2"><p id="confirmMessage" class="text-sm text-gray-500"></p></div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirmCancelBtn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">取消</button>
                <button id="confirmOkBtn" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition" style="background-color: #E89152;" onmouseover="this.style.backgroundColor='#D37644'" onmouseout="this.style.backgroundColor='#E89152'">確定</button>
            </div>
        </div>
    </div>

    <div id="errorModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 pointer-events-none opacity-0">
        <div class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-lg z-50 transform -translate-y-10 text-center p-6">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-4" style="background-color: #F5C17A;">
                <ion-icon name="alert-circle-outline" class="text-5xl" style="color: #D37644;"></ion-icon>
            </div>
            <h3 id="errorTitle" class="text-xl leading-6 font-bold text-gray-900">發生錯誤</h3>
            <div class="mt-2"><p id="errorMessage" class="text-sm text-gray-500"></p></div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="errorCloseBtn" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition" style="background-color: #E89152;" onmouseover="this.style.backgroundColor='#D37644'" onmouseout="this.style.backgroundColor='#E89152'">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-5 transition-all duration-300 flex items-center gap-2">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <span id="toast-message"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="loader h-12 w-12 rounded-full border-4 border-t-4 border-gray-200"></div>
        <p id="loading-message" class="text-gray-700 mt-4 text-lg">正在從 Google Sheet 載入學員名單...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Google Sheet & Local Storage ---
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxfEsIAxWNXP8zynB0aPHXeWVmMVvCPvwolvdYQ9QWMbXnZxMqhOX75R_R0XSuSX-uVpw/exec';
    const ATTENDEES_STORAGE_KEY = 'aiWorkshopAttendees_v3'; // v3 for Google Sheet sync

    // --- Data source ---
    let allAttendees = []; // 存放所有參與者資料
    const GROUPS = ["第一組", "第二組", "第三組", "第四組", "第五組", "第六組", "第七組"];

    // --- Page elements ---
    const tableBody = document.getElementById('attendeeTableBody');
    const searchInput = document.getElementById('searchInput');
    const addAttendeeBtn = document.getElementById('addAttendeeBtn');
    const exportBtn = document.getElementById('exportBtn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');

    // --- Modal elements ---
    const modal = document.getElementById('attendeeModal');
    const modalContent = document.getElementById('modal-content');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('modal-close');
    const cancelModalBtn = document.getElementById('formCancel');
    const overlay = document.getElementById('modal-overlay');
    const saveBtn = document.getElementById('formSave');
    const attendeeForm = document.getElementById('attendeeForm');
    const formGroup = document.getElementById('formGroup');
    const formName = document.getElementById('formName');
    const formOrganization = document.getElementById('formOrganization');
    const formTitle = document.getElementById('formTitle');
    const formCategory = document.getElementById('formCategory');
    const editUuidHidden = document.getElementById('editUuid');

    // --- Alert & Confirm Modals ---
    const alertModal = document.getElementById('alertModal');
    const alertTitle = document.getElementById('alertTitle');
    const alertIdBadge = document.getElementById('alertIdBadge');
    const alertMessage = document.getElementById('alertMessage');
    const alertCloseBtn = document.getElementById('alertCloseBtn');
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const errorModal = document.getElementById('errorModal');
    const errorTitle = document.getElementById('errorTitle');
    const errorMessage = document.getElementById('errorMessage');
    const errorCloseBtn = document.getElementById('errorCloseBtn');
    let confirmCallback = null;
    
    // --- Toast & Clock elements ---
    const toastEl = document.getElementById('toast');
    const toastMessageEl = document.getElementById('toast-message');
    const clockEl = document.getElementById('realtime-clock');

    // --- DATA PERSISTENCE FUNCTIONS ---
    function saveData() {
        try {
            localStorage.setItem(ATTENDEES_STORAGE_KEY, JSON.stringify(allAttendees));
        } catch (e) {
            // 改為非阻塞式處理：不要顯示大型錯誤 Modal，僅用 toast 提醒並記錄錯誤
            console.warn("localStorage 儲存失敗，改為暫存於記憶體 (或無法使用 localStorage):", e);
            showToast('⚠️ 本地備份無法寫入瀏覽器；簽到仍會同步到雲端。');
        }
    }

    // 新增：同步簽到狀態到 Google Sheet
    async function syncCheckInToSheet(uuid, action) {
        try {
            // 使用 application/x-www-form-urlencoded 避免瀏覽器發送 preflight OPTIONS
            const params = new URLSearchParams();
            params.append('uuid', uuid);
            params.append('action', action);

            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: params.toString()
            });

            if (!response.ok) {
                throw new Error(`網路回應錯誤: ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || '同步失敗');
            }

            return result;

        } catch (error) {
            console.error('同步到 Google Sheet 失敗:', error);
            // 不要阻止本地操作，但要顯示警告
            showToast(`⚠️ 本地簽到成功，但同步到雲端失敗: ${error.message}`);
            return { success: false, error: error.message };
        }
    }

    async function loadData() {
        try {
            loadingMessage.textContent = "正在從 Google Sheet 載入學員名單...";
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) {
                throw new Error(`網路回應錯誤: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            
            if (data.error) {
                throw new Error(`Apps Script 錯誤: ${data.message}`);
            }

            // 檢查新的資料格式 (v6 API 回傳 attendees 陣列)
            // 在 loadData 內 mapping 時，將 checkInTime/checkOutTime 正規化為 number (ms) 或 null
            if (data.attendees && Array.isArray(data.attendees)) {
                allAttendees = data.attendees.map(item => ({
                    uuid: item.uuid,
                    group: item.group || '',
                    name: item.name || '',
                    category: item.category || '學員',
                    organization: item.organization || '',
                    title: item.title || '',
                    // 正規化時間欄位：若為數字就直接用，若為字串嘗試 Date.parse，否則 null
                    checkedIn: !!item.checkedIn,
                    checkInTime: item.checkInTime ? (typeof item.checkInTime === 'number' ? item.checkInTime : (Date.parse(item.checkInTime) || null)) : null,
                    checkedOut: !!item.checkedOut,
                    checkOutTime: item.checkOutTime ? (typeof item.checkOutTime === 'number' ? item.checkOutTime : (Date.parse(item.checkOutTime) || null)) : null
                }));
                
                loadingMessage.textContent = `載入完成！共 ${allAttendees.length} 位參與者`;
                saveData(); // 儲存到本地
                
            } else if (Array.isArray(data)) {
                // 兼容舊格式
                allAttendees = data.map(item => ({
                    uuid: item.uuid || crypto.randomUUID(),
                    group: item.group || '',
                    name: item.name || '',
                    category: item.category || '學員',
                    organization: item.organization || '',
                    title: item.title || '',
                    checkedIn: !!item.checkedIn,
                    // 舊格式也正規化
                    checkInTime: item.checkInTime ? (typeof item.checkInTime === 'number' ? item.checkInTime : (Date.parse(item.checkInTime) || null)) : null
                }));
                saveData();
            } else {
                throw new Error("從 Google Sheet 載入的資料格式不正確。");
            }

        } catch (e) {
            console.error("載入 Google Sheet 資料失敗:", e);
            loadingMessage.textContent = "載入失敗，嘗試使用本地備份...";
            
            // 嘗試載入本地備份
            const storedAttendees = localStorage.getItem(ATTENDEES_STORAGE_KEY);
            if (storedAttendees) {
                try {
                    allAttendees = JSON.parse(storedAttendees);
                    loadingMessage.textContent = `使用本地備份，共 ${allAttendees.length} 位參與者（離線模式）`;
                } catch (parseError) {
                    console.error("解析本地備份失敗:", parseError);
                    allAttendees = [];
                }
            }
            
            if (allAttendees.length === 0) {
                // 改為非阻塞式通知（使用 toast），避免在部署環境顯示大型阻塞視窗
                console.warn('載入資料失敗，且無本地備份：', e);
                showToast(`⚠️ 載入 Google Sheet 失敗：${e.message}. 請檢查網路/部署。`);
            }
        }

        // 資料載入完成
        filterAndRender();
        updateStats();
        loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
    }
    
    // --- UI/UX HELPER FUNCTIONS ---
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-TW', { hour12: false });
        const dateString = now.toLocaleDateString('zh-TW');
        clockEl.textContent = `${dateString} ${timeString}`;
    }

    function showToast(message) {
        toastMessageEl.textContent = message;
        toastEl.classList.add('toast-show');
        setTimeout(() => {
            toastEl.classList.remove('toast-show');
        }, 3000);
    }

    // 正規化可能為秒、毫秒或字串的時間，回傳毫秒（number）或 null
    function normalizeTimestamp(ts) {
        if (ts === null || ts === undefined || ts === '') return null;
        // 如果是字串，先嘗試 parse 為毫秒
        if (typeof ts === 'string') {
            const parsed = Date.parse(ts);
            if (!isNaN(parsed)) return parsed;
            // 否則嘗試當數字字串處理
            const asNum = Number(ts);
            if (!isNaN(asNum)) ts = asNum;
        }
        if (typeof ts === 'number') {
            // 若看起來像秒（小於 1e12），就乘 1000 轉成毫秒
            return ts < 1e12 ? Math.round(ts * 1000) : Math.round(ts);
        }
        return null;
    }
    
    // 輸出固定格式的本地時間字串：YYYY/MM/DD HH:mm:ss，若無時間回傳空字串
    function formatLocalDateTime(ts) {
        const ms = normalizeTimestamp(ts);
        if (!ms) return '';
        const d = new Date(ms);
        const pad = (n) => String(n).padStart(2, '0');
        return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    
    // --- MODAL FUNCTIONS (新增 error modal) ---
    function openModal() { modal.classList.remove('opacity-0', 'pointer-events-none'); modalContent.classList.remove('-translate-y-10'); }
    function closeModal() { modal.classList.add('opacity-0', 'pointer-events-none'); modalContent.classList.add('-translate-y-10'); attendeeForm.reset(); editUuidHidden.value = ''; }
    
    function openAlertModal(person) { 
        alertTitle.innerHTML = `<span class="font-normal">${person.group}</span> ${person.name}`;
        alertIdBadge.innerHTML = `<p class="flex items-center justify-center gap-2"><ion-icon name="person-outline"></ion-icon> ${person.title || '學員'}</p>`;
        
        // 第六組和第七組顯示特別提醒
        if (person.group === '第六組' || person.group === '第七組') {
            alertMessage.innerHTML = '<p>一切順利，歡迎您的蒞臨！</p><p class="mt-3 font-semibold" style="color: #E89152;"><ion-icon name="location-outline"></ion-icon> 上課地點在貓頭鷹手作教室唷</p>';
        } else {
            alertMessage.innerHTML = '<p>一切順利，歡迎您的蒞臨！</p>';
        }
        
        alertModal.classList.remove('opacity-0', 'pointer-events-none'); 
        alertModal.querySelector('.modal-content').classList.remove('-translate-y-10'); 
    }
    function closeAlertModal() { alertModal.classList.add('opacity-0', 'pointer-events-none'); alertModal.querySelector('.modal-content').classList.add('-translate-y-10'); }
    
    function openConfirmModal(title, message, callback) { confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = callback; confirmModal.classList.remove('opacity-0', 'pointer-events-none'); confirmModal.querySelector('.modal-content').classList.remove('-translate-y-10'); }
    function closeConfirmModal() { confirmModal.classList.add('opacity-0', 'pointer-events-none'); confirmModal.querySelector('.modal-content').classList.add('-translate-y-10'); confirmCallback = null; }

    function openErrorModal(title, message) { errorTitle.textContent = title; errorMessage.innerHTML = message; errorModal.classList.remove('opacity-0', 'pointer-events-none'); errorModal.querySelector('.modal-content').classList.remove('-translate-y-10'); }
    function closeErrorModal() { errorModal.classList.add('opacity-0', 'pointer-events-none'); errorModal.querySelector('.modal-content').classList.add('-translate-y-10'); }

    
    function animateValue(element, start, end, duration, isPercentage = false) {
        if (!element) return;
        if (start === end) {
             element.textContent = isPercentage ? `${end}%` : end;
             return;
        }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentValue = Math.floor(progress * (end - start) + start);
            element.textContent = isPercentage ? `${currentValue}%` : currentValue;
            if (progress < 1) { window.requestAnimationFrame(step); } else { element.textContent = isPercentage ? `${end}%` : end; element.classList.add('number-pop-animation'); setTimeout(() => { element.classList.remove('number-pop-animation'); }, 300); }
        };
        window.requestAnimationFrame(step);
    }

    // --- MAIN FUNCTIONS ---
    function renderTable(data) {
        tableBody.innerHTML = '';
        if (data.length === 0) { 
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">找不到資料</td></tr>'; 
            return; 
        }

        // 自訂組別排序函式
        const groupSortOrder = GROUPS.reduce((acc, group, index) => {
            acc[group] = index;
            return acc;
        }, {});

        const sortCompare = (a, b) => {
            const groupA = groupSortOrder[a.group] ?? 99;
            const groupB = groupSortOrder[b.group] ?? 99;
            
            if (groupA !== groupB) {
                return groupA - groupB; // 依組別排序
            }
            // 組別相同時，依姓名排序
            return a.name.localeCompare(b.name, 'zh-Hant');
        };

        // 1. 分離已報到和未報到
        const checkedInList = data.filter(p => p.checkedIn);
        const notCheckedInList = data.filter(p => !p.checkedIn);

        // 2. 分別排序
        // 已報到：依組別，組別相同則依報到時間 (新->舊)
        checkedInList.sort((a, b) => {
            const groupA = groupSortOrder[a.group] ?? 99;
            const groupB = groupSortOrder[b.group] ?? 99;

            if (groupA !== groupB) {
                return groupA - groupB;
            }
            // 組別相同，依報到時間
            return new Date(b.checkInTime) - new Date(a.checkInTime);
        });

        // 未報到：依組別，組別相同則依姓名
        notCheckedInList.sort(sortCompare);

        // 3. 組合並渲染
        const combinedList = [...checkedInList, ...notCheckedInList];
        
        combinedList.forEach(p => {
            const row = document.createElement('tr');
            row.className = p.checkedIn ? 'bg-green-50' : '';
            row.innerHTML = `
                <td class="table-cell"><span class="flex items-center gap-2 ${p.checkedIn ? 'text-green-600' : 'text-gray-500'}"><ion-icon name="${p.checkedIn ? 'checkmark-circle' : 'ellipse-outline'}"></ion-icon>${p.checkedIn ? '已報到' : '未報到'}</span></td>
                <td class="table-cell font-mono">${p.group}</td>
                <td class="table-cell"><span class="font-semibold ${p.category === '講師' ? 'text-purple-700' : (p.category === '工作人員' ? 'text-orange-700' : 'text-gray-800')}">${p.category}</span></td>
                <td class="table-cell">${p.organization}</td>
                <td class="table-cell">${p.title}</td>
                <td class="table-cell font-semibold">${p.name}</td>
                <td class="table-cell">
                    <div class="flex items-center justify-end gap-1">
                        ${p.checkedIn ? `
                            <div class="flex-grow text-left text-green-600">
                                <p class="font-semibold flex items-center gap-1"><ion-icon name="checkmark-done-outline"></ion-icon>已簽到</p>
                                <p class="text-xs text-gray-500">${formatLocalDateTime(p.checkInTime)}</p>
                            </div>
                            <button class="cancel-btn text-gray-500 p-2 rounded-md hover:bg-red-100 hover:text-red-600" data-uuid="${p.uuid}" title="取消簽到">
                                <ion-icon name="arrow-undo-outline" class="pointer-events-none"></ion-icon>
                            </button>` 
                        : `
                            <button class="checkin-btn text-white px-3 py-1 rounded-md" style="background-color: #5B9FB6;" data-uuid="${p.uuid}" onmouseover="this.style.backgroundColor='#2B4856'" onmouseout="this.style.backgroundColor='#5B9FB6'">簽到</button>`
                        }
                        <button class="edit-btn text-gray-500 p-2 rounded-md hover:bg-gray-200" data-uuid="${p.uuid}" title="編輯資料">
                            <ion-icon name="create-outline" class="pointer-events-none"></ion-icon>
                        </button>
                    </div>
                </td>`;
            tableBody.appendChild(row);
        });
    }

    function updateStats() {
        // --- 主要儀表板 ---
        const total = allAttendees.length;
        const newCheckedIn = allAttendees.filter(a => a.checkedIn).length;
        const newRate = total > 0 ? Math.round((newCheckedIn / total) * 100) : 0;
        
        const totalAttendeesEl = document.getElementById('totalAttendees');
        const totalCheckedInEl = document.getElementById('totalCheckedIn');
        const totalAttendanceRateEl = document.getElementById('totalAttendanceRate');

        animateValue(totalAttendeesEl, parseInt(totalAttendeesEl.textContent) || 0, total, 300);
        animateValue(totalCheckedInEl, parseInt(totalCheckedInEl.textContent) || 0, newCheckedIn, 300);
        animateValue(totalAttendanceRateEl, parseInt(totalAttendanceRateEl.textContent.replace('%','')) || 0, newRate, 300, true);

        // --- 各組儀表板 (只統計 '學員') ---
        const groupStatsContainer = document.getElementById('group-stats-container');
        groupStatsContainer.innerHTML = ''; // 清空
        
        const studentAttendees = allAttendees.filter(a => a.category === '學員');

        GROUPS.forEach(groupName => {
            const groupAttendees = studentAttendees.filter(a => a.group === groupName);
            const totalInGroup = groupAttendees.length;
            const checkedInInGroup = groupAttendees.filter(a => a.checkedIn).length;
            
            const card = document.createElement('div');
            const isComplete = checkedInInGroup === totalInGroup && totalInGroup > 0;
            card.className = 'p-3 rounded-xl text-center';
            card.style.backgroundColor = isComplete ? '#5B9FB6' : '#A8C5D1';
            card.innerHTML = `
                <h3 class="text-sm font-semibold" style="color: ${isComplete ? '#FFFFFF' : '#2B4856'};">${groupName}</h3>
                <p class="text-3xl font-bold mt-1" style="color: ${isComplete ? '#FFFFFF' : '#1A2328'};">
                    <span id="group-checked-${groupName}">${checkedInInGroup}</span>
                    <span class="text-xl" style="color: ${isComplete ? 'rgba(255,255,255,0.7)' : '#5B9FB6'};">/ ${totalInGroup}</span>
                </p>
            `;
            groupStatsContainer.appendChild(card);
        });
    }

    async function handleCheckIn(uuid) {
        const person = allAttendees.find(p => p.uuid === uuid);
        if (!person || person.checkedIn) return;

        // 先更新本地狀態（使用 timestamp 整數，避免字串解析問題）
        person.checkedIn = true;
        person.checkInTime = Date.now(); // <- 改為數字時間戳

        // 立即更新 UI
        filterAndRender();
        updateStats();
        saveData();

        // 顯示成功訊息
        openAlertModal(person);

        // 背景同步到 Google Sheet（後端仍可記錄/轉換）
        syncCheckInToSheet(uuid, 'checkin');
    }

    async function handleCancelCheckIn(uuid) {
        const person = allAttendees.find(p => p.uuid === uuid);
        if (!person || !person.checkedIn) return;

        openConfirmModal('取消簽到確認', `您確定要取消【${person.name}】的簽到狀態嗎？`, async () => {
            // 先更新本地狀態：取消簽到並清空時間（null）
            person.checkedIn = false;
            person.checkInTime = null;

            // 立即更新 UI
            filterAndRender();
            updateStats();
            saveData();

            showToast(`${person.name} 的簽到狀態已取消`);

            // 同步取消簽到到 Google Sheet
            try {
                await syncCheckInToSheet(uuid, 'cancel_checkin');
            } catch (err) {
                console.error('取消簽到同步失敗', err);
            }
        });
    }

    function handleEdit(uuid) {
        const person = allAttendees.find(p => p.uuid === uuid);
        if(person) {
            modalTitle.textContent = '編輯參與者資料'; 
            editUuidHidden.value = person.uuid; 
            formGroup.value = person.group;
            formName.value = person.name; 
            formOrganization.value = person.organization;
            formTitle.value = person.title;
            formCategory.value = person.category;
            openModal();
        }
    }

    function filterAndRender() {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = allAttendees.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            p.organization.toLowerCase().includes(searchTerm) || 
            p.title.toLowerCase().includes(searchTerm) ||
            p.group.toLowerCase().includes(searchTerm)
        );
        renderTable(filtered);
    }

    function exportToCSV() {
        const headers = ['狀態', '組別', '身份類別', '姓名', '服務單位/部門', '職稱', '報到時間'];
        const rows = allAttendees.map(p => {
            const timeStr = formatLocalDateTime(p.checkInTime);
            return [
                p.checkedIn ? '已報到' : '未報到',
                p.group,
                p.category,
                p.name,
                p.organization,
                p.title,
                timeStr
            ].map(field => `"${String(field ?? '').replace(/"/g, '""')}"`).join(',');
        });

        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers.join(','), ...rows].join('\n');
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `AI工作坊報到資料_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // --- EVENT LISTENERS ---
    addAttendeeBtn.addEventListener('click', () => { 
        modalTitle.textContent = '新增參與者'; 
        attendeeForm.reset();
        editUuidHidden.value = '';
        openModal(); 
    });
    
    closeModalBtn.addEventListener('click', closeModal);
    cancelModalBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);
    
    alertCloseBtn.addEventListener('click', closeAlertModal);
    
    confirmCancelBtn.addEventListener('click', closeConfirmModal);
    confirmOkBtn.addEventListener('click', () => { 
        if (typeof confirmCallback === 'function') { 
            confirmCallback(); 
        } 
        closeConfirmModal(); 
    });

    errorCloseBtn.addEventListener('click', closeErrorModal);

    exportBtn.addEventListener('click', exportToCSV);

    saveBtn.addEventListener('click', async () => {
        const uuidToSave = editUuidHidden.value;
        const data = { 
            group: formGroup.value.trim(),
            name: formName.value.trim(), 
            organization: formOrganization.value.trim(), 
            title: formTitle.value.trim(), 
            category: formCategory.value, 
        };
        
        if (!data.name) {
            openErrorModal("資料不完整", "「姓名」為必填欄位！");
            return;
        }

        // 若為編輯，先更新本地，再送到後端同步
        if (uuidToSave) { 
            const index = allAttendees.findIndex(p => p.uuid === uuidToSave); 
            if (index !== -1) { 
                const existingData = allAttendees[index]; 
                allAttendees[index] = { ...existingData, ...data }; 
            }

            // 同步編輯到 Google Sheet (後端會以 uuid 定位並更新提供的欄位)
            try {
                const params = new URLSearchParams();
                params.append('uuid', uuidToSave);
                Object.keys(data).forEach(k => params.append(k, data[k]));

                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: params.toString()
                });
                const resJson = await resp.json();
                if (!resJson.success) {
                    showToast('⚠️ 已更新本地，但同步到雲端失敗');
                }
            } catch (err) {
                console.error('同步編輯失敗', err);
                showToast('⚠️ 已更新本地，但同步到雲端失敗');
            }

        } else { 
            // 新增：先在後端新增列，後端會回傳 uuid
            try {
                const params = new URLSearchParams();
                Object.keys(data).forEach(k => params.append(k, data[k]));
                params.append('action', '');

                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: params.toString()
                });
                const resJson = await resp.json();
                if (resJson.success) {
                    const newUuid = resJson.uuid || crypto.randomUUID();
                    allAttendees.unshift({ 
                        ...data, 
                        uuid: newUuid, 
                        checkedIn: false, 
                        checkInTime: null 
                    }); 
                } else {
                    allAttendees.unshift({ 
                        ...data, 
                        uuid: crypto.randomUUID(), 
                        checkedIn: false, 
                        checkInTime: null 
                    }); 
                    showToast('⚠️ 無法同步到雲端，已在本地儲存');
                }
            } catch (err) {
                console.error('新增到後端失敗', err);
                allAttendees.unshift({ 
                    ...data, 
                    uuid: crypto.randomUUID(), 
                    checkedIn: false, 
                    checkInTime: null 
                }); 
                showToast('⚠️ 無法同步到雲端，已在本地儲存');
            }
        }

        closeModal(); 
        filterAndRender(); 
        updateStats(); 
        saveData(); 
        showToast('資料已儲存！');
    });

    searchInput.addEventListener('input', filterAndRender);
    
    tableBody.addEventListener('click', (e) => {
        const checkinBtn = e.target.closest('.checkin-btn');
        const editBtn = e.target.closest('.edit-btn');
        const cancelBtn = e.target.closest('.cancel-btn');
        
        if (checkinBtn) handleCheckIn(checkinBtn.dataset.uuid);
        if (editBtn) handleEdit(editBtn.dataset.uuid);
        if (cancelBtn) handleCancelCheckIn(cancelBtn.dataset.uuid);
    });

    // --- INITIAL LOAD ---
    loadData(); // 啟動資料載入
    updateClock();
    setInterval(updateClock, 1000); // Update clock every second
});
</script>

</body>
</html>
